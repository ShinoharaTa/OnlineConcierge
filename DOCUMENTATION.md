# 篠川Nostr Bot ドキュメント

## 概要
このBotは、Nostrのタイムラインをリアルタイム監視し、特定のメンション・コマンドに反応して動作するNostr Botです。主にGoogle Calendarとの連携やサモンコマンドの応答機能を提供します。

## アーキテクチャ

### 技術スタック
- **言語**: TypeScript
- **Nostrライブラリ**: nostr-tools (v1.11.1)
- **外部API**: Google Calendar API, OpenAI API
- **実行環境**: Node.js
- **スケジューラー**: node-cron

### 監視対象
- **リレー**: 
  - wss://relay-jp.nostr.wirednet.jp
  - wss://r.kojira.io
  - wss://yabu.me
  - wss://relay-jp.shino3.net
- **イベント種別**: Kind 1 (テキストノート)
- **監視範囲**: リアルタイム（起動時点以降のイベント）

## 機能一覧

### 1. Google Calendarイベント登録機能

#### 機能概要
ユーザーがBotにメンションでスケジュール情報を送信すると、自動的にGoogle Calendarにイベントを登録する機能。

#### 動作条件
- Botに対するリプライ（メンション）
- コマンド形式: `予定 [イベント内容]`
- 実行権限: safelistに登録されたユーザーのみ実際の登録が可能

#### 処理フロー
1. **メンション検知**: Botへのリプライを監視
2. **コマンド解析**: 「予定」で始まるメッセージを抽出
3. **AI解析**: OpenAI GPT-4o-miniを使用してメンション内容を構造化
4. **カレンダー登録**: 
   - safelist内ユーザー: 実際にGoogle Calendarに登録
   - その他のユーザー: 登録URLのみ提供
5. **応答**: 登録結果とGoogleカレンダーテンプレートURLを返信

#### safelist
```
- fe9edd5d5c635dd2900f1f86a872e81ce1d6e20bd4e06549f133ae6bf158913b
- 98a72996aecaef8a4b708d149ad2e06549f133ae6bf158913b
```

#### AI解析仕様
- **入力**: メンション内容、現在時刻
- **出力**: JSON形式のカレンダーイベント
  ```json
  {
    "summary": "イベントタイトル",
    "description": "イベントの説明", 
    "start": "ISO 8601形式の開始日時",
    "end": "ISO 8601形式の終了日時",
    "location": "場所"
  }
  ```
- **タイムゾーン**: Asia/Tokyo
- **相対日付対応**: 「明日」「来週」等の表現を現在時刻基準で解釈

### 2. サモンコマンド機能

#### 機能概要
特定のキーワードに反応して定型メッセージを返信する機能。

#### 動作条件
- **トリガー**: `^サモン！` で始まる投稿
- **応答**: `サーモン！`

#### 処理フロー
1. **キーワード検知**: 「サモン！」で始まる投稿を監視
2. **即座応答**: 「サーモン！」を返信

### 3. おじさん構文応答機能（現在無効化）

#### 機能概要
特定ユーザーの投稿に対して、AI生成のおじさん構文で返信する機能。
※現在はコメントアウトされており無効状態

#### 動作仕様（無効時）
- **対象**: 特定のNostrユーザー（ojisanExists関数で判定）
- **応答頻度**: 6%の確率
- **AI生成**: OpenAI GPT-4o-miniでおじさん構文を生成
- **制限**: 同一ユーザーへの連続応答制限（最新10件まで）

### 4. パスポート機能（現在無効化）

#### 機能概要
定期的に特定ユーザーに向けてパスポートメッセージを送信する機能。
※現在はコメントアウトされており無効状態

#### 動作仕様（無効時）
- **スケジュール**: 毎日午前1時
- **送信先**: npub1823chanrkmyrfgz2v4pwmu22s8fjy0s9ps7vnd68n7xgd8zr9neqlc2e5r
- **メッセージ**: "nostr:npub1823chanrkmyrfgz2v4pwmu22s8fjy0s9ps7vnd68n7xgd8zr9neqlc2e5r passport"

## システム動作

### 起動・終了制御
- **自動再起動**: 30分間隔でプロセス終了（外部プロセス管理システムによる再起動前提）
- **エラーハンドリング**: try-catch文でエラーをコンソール出力

### 認証・権限管理
- **Nostr秘密鍵**: 
  - メイン: HEX環境変数
  - おじさん用: OJI_HEX環境変数
  - パスポート用: PASSPORT_HEX環境変数
- **Google認証**: OAuth2による認証、token.json に保存
- **OpenAI API**: OPENAI_API_KEY環境変数

### イベント送信仕様
- **作成時刻**: リプライ時は元イベント+1秒、それ以外は現在時刻
- **タグ付け**: リプライ時は自動的にeタグ（イベントID）とpタグ（ユーザー公開鍵）を追加

## 環境設定

### 必要な環境変数
```
HEX=メインBot用Nostr秘密鍵（16進数）
OJI_HEX=おじさんBot用Nostr秘密鍵（16進数）
PASSPORT_HEX=パスポート用Nostr秘密鍵（16進数）
OPENAI_API_KEY=OpenAI APIキー
```

### 必要なファイル
- `credentials.json`: Google Calendar API認証情報
- `token.json`: Google認証トークン（自動生成）

## 注意事項
- 30分間隔でプロセス自動終了するため、継続稼働にはプロセス管理システムが必要
- Google Calendar APIには利用制限があるため大量実行時は注意
- OpenAI API使用によりコストが発生
- safelistに登録されていないユーザーは実際のカレンダー登録は行われない 